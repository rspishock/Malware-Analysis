#! /usr/bin/python
from os import path

import argparse
import re
import sys


def get_arguments():
    """Get user supplied arguments from terminal."""
    parser = argparse.ArgumentParser()
    parser.add_argument('-i', '--input', dest='input', help='File to parse strings from.')
    parser.add_argument('-o', '--output', dest='output', help='File to write parsed strings to.')
    parser.add_argument('-d', '--descriptor', dest='descriptor', help='Malware descriptor.  Will be used to append '
                                                                      'regex outputs to')
    (options) = parser.parse_args()

    return options


# argument variables
options = get_arguments()
input_file = options.input
output_file = options.output
descriptor = options.descriptor

# user variables
path_count = 0
dll_count = 0
crypto_count = 0

try:
    if path.exists(input_file):
        # file to read from
        with open(input_file) as file_object:
            with open(f'{descriptor}.dll.txt', 'w') as output:
                output.write("Located .dll files:\n")
                for line in file_object:
                    # dll regex
                    dll_regex = re.compile(f'@?[a-zA-Z0-9-_]*\.dll')
                    file = dll_regex.search(line)

                    # write dll files to file_out.txt
                    if file:
                        dll_count += 1
                        print(f'\t{file.group(0)}')
                        output.write(f'\t{file.group(0)}\n')
                    else:
                        pass

                output.write(f'\n\nNumber of dll files found: {dll_count}.')

    else:
        print(f'File {input_file} does not exist.')
        print('Check filename and rerun script.')
        sys.exit()

except IOError:
    sys.exit
